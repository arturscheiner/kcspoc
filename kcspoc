#!/bin/bash

# ==============================================================================
# Script: kcspoc
# Description: CLI tool for Kaspersky Container Security PoC management.
#              Provides interactive configuration, environment checking, and preparation.
# Environment: Linux (Ubuntu/Debian preferred), K8s
# Version: 0.3.0 (Modular)
# ==============================================================================

set -e

# Resolve Script Directory to find libs
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Check lib existence
if [ ! -d "$LIB_DIR" ]; then
    echo "Error: Library directory not found at $LIB_DIR"
    exit 1
fi

# Source Common Libs
source "$LIB_DIR/common.sh"

# Source Commands
source "$LIB_DIR/cmd_config.sh"
source "$LIB_DIR/cmd_pull.sh"
source "$LIB_DIR/cmd_check.sh"
source "$LIB_DIR/cmd_prepare.sh"
source "$LIB_DIR/cmd_destroy.sh"

cmd_usage() {
    ui_banner
    echo -e "${BOLD}${MSG_USAGE}:${NC} $(basename "$0") [command] [options]"
    echo ""
    echo -e "${BOLD}${MSG_COMMANDS}:${NC}"
    echo -e "  ${GREEN}config${NC}   ${MSG_CMD_CONFIG_DESC}"
    echo -e "  ${GREEN}pull${NC}     ${MSG_CMD_PULL_DESC}"
    echo -e "  ${GREEN}check${NC}    ${MSG_CMD_CHECK_DESC}"
    echo -e "  ${GREEN}prepare${NC}  ${MSG_CMD_PREPARE_DESC}"
    echo -e "  ${GREEN}destroy${NC}  ${MSG_DESTROY_TITLE}"
    echo -e "  ${GREEN}help${NC}     ${MSG_CMD_HELP_DESC}"
    exit 0
}

# --- CLI Logic ---

# 1. Detect Global Debug Flag
ARGS=()
for arg in "$@"; do
    if [[ "$arg" == "--debug" ]]; then
        KCS_DEBUG=true
    else
        ARGS+=("$arg")
    fi
done

# Restores the args without --debug
set -- "${ARGS[@]}"

# Helper for final debug message
finish_debug() {
    if [ "$KCS_DEBUG" = true ]; then
        echo ""
        echo -e "${BLUE}${ICON_INFO} Debug logs saved to: ${BOLD}$DEBUG_OUT${NC}"
    fi
}

case "$1" in
    config)
        shift
        setup_debug "config"
        cmd_config "$@"
        finish_debug
        ;;
    pull)
        shift
        setup_debug "pull"
        cmd_pull "$@"
        finish_debug
        ;;
    check)
        shift
        setup_debug "check"
        cmd_check "$@"
        finish_debug
        ;;
    prepare)
        shift
        setup_debug "prepare"
        cmd_prepare "$@"
        finish_debug
        ;;
    destroy)
        shift
        setup_debug "destroy"
        cmd_destroy "$@"
        finish_debug
        ;;
    help|*)
        cmd_usage
        ;;
esac
