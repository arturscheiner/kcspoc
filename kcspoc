#!/bin/bash

# ==============================================================================
# Script: kcspoc
# Description: CLI tool for Kaspersky Container Security PoC management.
#              Provides interactive configuration, environment checking, and preparation.
# Environment: Linux (Ubuntu/Debian preferred), K8s
# Version: 0.3.0 (Modular)
# ==============================================================================

set -e

# Resolve Script Directory to find libs (Handles Symlinks)
SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
SCRIPT_DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
LIB_DIR="$SCRIPT_DIR/lib"

# Check lib existence
if [ ! -d "$LIB_DIR" ]; then
    echo "Error: Library directory not found at $LIB_DIR"
    exit 1
fi

# Source Common Libs
source "$LIB_DIR/common.sh"

# Source Commands
source "$LIB_DIR/cmd_config.sh"
source "$LIB_DIR/cmd_pull.sh"
source "$LIB_DIR/cmd_check.sh"
source "$LIB_DIR/cmd_prepare.sh"
source "$LIB_DIR/cmd_deploy.sh"
source "$LIB_DIR/cmd_destroy.sh"
source "$LIB_DIR/cmd_logs.sh"

cmd_usage() {
    ui_banner
    echo -e "${BLUE}${BOLD}${MSG_USAGE}:${NC}"
    echo -e "  kcspoc <command> [options]\n"

    echo -e "${BLUE}${BOLD}${MSG_COMMANDS}:${NC}"
    printf "  ${CYAN}%-10s${NC} %s\n" "config"  "$MSG_CMD_CONFIG_DESC"
    printf "  ${CYAN}%-10s${NC} %s\n" "pull"    "$MSG_CMD_PULL_DESC"
    printf "  ${CYAN}%-10s${NC} %s\n" "check"   "$MSG_CMD_CHECK_DESC"
    printf "  ${CYAN}%-10s${NC} %s\n" "prepare" "$MSG_CMD_PREPARE_DESC"
    printf "  ${CYAN}%-10s${NC} %s\n" "deploy"  "$MSG_CMD_DEPLOY_DESC"
    printf "  ${CYAN}%-10s${NC} %s\n" "destroy" "$MSG_DESTROY_TITLE"
    printf "  ${CYAN}%-10s${NC} %s\n" "logs"    "Manage logs (--list, --show, --cleanup)"
    printf "  ${CYAN}%-10s${NC} %s\n" "help"    "$MSG_CMD_HELP_DESC"
    echo ""

    echo -e "${BLUE}${BOLD}${MSG_HELP_EXAMPLES}:${NC}"
    echo -e "  ${DIM}# Start here${NC}"
    echo -e "  kcspoc config"
    echo -e "  kcspoc check"
    echo ""
    echo -e "  ${DIM}# Installation flow${NC}"
    echo -e "  kcspoc pull"
    echo -e "  kcspoc prepare"
    echo -e "  kcspoc deploy --core"
    echo ""
    echo -e "  ${DIM}# Troubleshooting${NC}"
    echo -e "  kcspoc logs --list"
    echo ""
    exit 0
}

# --- CLI Logic ---

# Global Debug is now ALWAYS ON by default (handled by init_logging)
KCS_DEBUG=true

# Helper to check if help is requested (to avoid creating log files)
cmd_needs_logging() {
    for arg in "$@"; do
        if [[ "$arg" == "help" ]] || [[ "$arg" == "--help" ]] || [[ "$arg" == "-h" ]]; then
            return 1
        fi
    done
    return 0
}

case "$1" in
    config)
        shift
        cmd_needs_logging "$@" && init_logging "config"
        cmd_config "$@"
        ;;
    pull)
        shift
        cmd_needs_logging "$@" && init_logging "pull"
        cmd_pull "$@"
        ;;
    check)
        shift
        cmd_needs_logging "$@" && init_logging "check"
        cmd_check "$@"
        ;;
    prepare)
        shift
        cmd_needs_logging "$@" && init_logging "prepare"
        cmd_prepare "$@"
        ;;
    deploy)
        shift
        cmd_needs_logging "$@" && init_logging "deploy"
        cmd_deploy "$@"
        ;;
    destroy)
        shift
        cmd_needs_logging "$@" && init_logging "destroy"
        cmd_destroy "$@"
        ;;
    logs)
        shift
        # No logging for the logs command itself
        cmd_logs "$@"
        ;;
    help|*)
        cmd_usage
        ;;
esac
