#!/bin/bash

# ==============================================================================
# Script: kcspoc.sh
# Description: CLI tool for Kaspersky Container Security PoC management.
#              Provides interactive configuration, environment checking, and preparation.
# Environment: Linux (Ubuntu/Debian preferred), K8s
# Version: 0.2.0 (Modular)
# ==============================================================================

set -e

# Resolve Script Directory to find libs
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Check lib existence
if [ ! -d "$LIB_DIR" ]; then
    echo "Error: Library directory not found at $LIB_DIR"
    exit 1
fi

# Source Common Libs
source "$LIB_DIR/common.sh"

# Source Commands
source "$LIB_DIR/cmd_config.sh"
source "$LIB_DIR/cmd_pull.sh"
source "$LIB_DIR/cmd_check.sh"
source "$LIB_DIR/cmd_prepare.sh"

cmd_usage() {
    ui_banner
    echo -e "${BOLD}Usage:${NC} $(basename "$0") [command] [options]"
    echo ""
    echo -e "${BOLD}Commands:${NC}"
    echo -e "  ${GREEN}config${NC}   Run interactive configuration wizard"
    echo -e "  ${GREEN}pull${NC}     Download KCS chart (usage: pull [--version X.X.X])"
    echo -e "  ${GREEN}check${NC}    Verify environment and prerequisites"
    echo -e "  ${GREEN}prepare${NC}  Run the installation preparation (requires config)"
    echo -e "  ${GREEN}help${NC}     Show this help message"
    exit 0
}

# --- MAIN ---

case "$1" in
    config)
        cmd_config
        ;;
    pull)
        shift # Remove 'pull' (so $1 becomes --version if present)
        cmd_pull "$@"
        ;;
    check)
        cmd_check
        ;;
    prepare)
        cmd_prepare
        ;;
    help|*)
        cmd_usage
        ;;
esac
