#!/bin/bash

# ==============================================================================
# Script: kcspoc
# Description: CLI tool for Kaspersky Container Security PoC management.
#              Provides interactive configuration, environment checking, and preparation.
# Environment: Linux (Ubuntu/Debian preferred), K8s
# Version: 0.3.0 (Modular)
# ==============================================================================

set -e

# Resolve Script Directory to find libs
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$SCRIPT_DIR/lib"

# Check lib existence
if [ ! -d "$LIB_DIR" ]; then
    echo "Error: Library directory not found at $LIB_DIR"
    exit 1
fi

# Source Common Libs
source "$LIB_DIR/common.sh"

# Source Commands
source "$LIB_DIR/cmd_config.sh"
source "$LIB_DIR/cmd_pull.sh"
source "$LIB_DIR/cmd_check.sh"
source "$LIB_DIR/cmd_prepare.sh"
source "$LIB_DIR/cmd_destroy.sh"
source "$LIB_DIR/cmd_logs.sh"

cmd_usage() {
    ui_banner
    echo -e "${BOLD}${MSG_USAGE}:${NC} $(basename "$0") [command] [options]"
    echo ""
    echo -e "${BOLD}${MSG_COMMANDS}:${NC}"
    echo -e "  ${GREEN}config${NC}   ${MSG_CMD_CONFIG_DESC}"
    echo -e "  ${GREEN}pull${NC}     ${MSG_CMD_PULL_DESC}"
    echo -e "  ${GREEN}check${NC}    ${MSG_CMD_CHECK_DESC}"
    echo -e "  ${GREEN}prepare${NC}  ${MSG_CMD_PREPARE_DESC}"
    echo -e "  ${GREEN}destroy${NC}  ${MSG_DESTROY_TITLE}"
    echo -e "  ${GREEN}logs${NC}     Manage execution logs (--list, --show)"
    echo -e "  ${GREEN}help${NC}     ${MSG_CMD_HELP_DESC}"
    exit 0
}

# --- CLI Logic ---

# Global Debug is now ALWAYS ON by default (handled by init_logging)
KCS_DEBUG=true

case "$1" in
    config)
        shift
        init_logging "config"
        cmd_config "$@"
        ;;
    pull)
        shift
        init_logging "pull"
        cmd_pull "$@"
        ;;
    check)
        shift
        init_logging "check"
        cmd_check "$@"
        ;;
    prepare)
        shift
        init_logging "prepare"
        cmd_prepare "$@"
        ;;
    destroy)
        shift
        init_logging "destroy"
        cmd_destroy "$@"
        ;;
    logs)
        shift
        # No logging for the logs command itself
        cmd_logs "$@"
        ;;
    help|*)
        cmd_usage
        ;;
esac
