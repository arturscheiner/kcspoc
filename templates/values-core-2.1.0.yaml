################################################################################
# values-final-210.yaml
# FOCO: Bootstrap da versão base com fix de Certificados (certSource)
################################################################################

commonLabels:
  provisioned-by: "kcspoc"

default:
  platform: "$PLATFORM_CONFIGURED"
  domain: "$DOMAIN_CONFIGURED"
  # --- CORREÇÃO DEFINITIVA PARA v2.1.0 (mTLS & CA) ---
  # Estas chaves garantem que o Helm renderize o "Certificate" e o "Issuer"
  # necessários para gerar o segredo 'cert-ca' e 'cert-kcs-s3'.
  certSource: "helm"
  internalTLS:
    enabled: true
    certSource: "helm"
  
  certManager:
    enabled: true

  # Redução de réplicas para evitar o status 'Pending' no laboratório
  kcs-ih:
    replicaCount: 1

  # --- CORREÇÃO DO ERRO networkPolicy.yaml ---
  networkPolicies:
    create: true
    ingressControllerNamespaces:
      - ingress-nginx        # Namespace onde o nosso 'porteiro' reside

  postgresql:
    resources:
      requests: { cpu: "100m", memory: "512Mi" }
      limits: { cpu: "500m", memory: "1Gi" }
# --- AGENTE DE SEGURANÇA (VISIBILIDADE EM TEMPO REAL) ---
nodeAgent:
  enabled: true
  # Caminho para o Lab (containerd)
  runtimeSocketPath: "$CRI_SOCKET_CONFIG"
  installStrategy: DaemonSet

# --- CONTROLE DE ADMISSÃO (O "SEGURANÇA" DO CLUSTER) ---
admissionController:
  enabled: true
  replicaCount: 1

# --- ATUALIZAÇÕES AUTOMÁTICAS ---
updates:
  enabled: true
  
configmap:
  infraconfig:
    type: fromEnvs
    envs:
      TLS_INTERNAL: true  # Exige certificados mTLS internos
      TLS_INGRESS: false
      # Tags de imagem fixas para a v2.1.0
      KUBE_AGENT_TAG: v2.1.0
      NODE_AGENT_TAG: v2.1.0
      SCANNER_TAG: v2.1.0
      IMAGE_TAG_MIDDLEWARE: v2.1.0

# O emissor local que o Cert-Manager usará para assinar a CA interna
issuer:
  create: true
  name: kcs-issuer
  kind: Issuer
  # Na v2.1.0, esta flag ajuda a gerar a CA auto-assinada se o segredo 'cert-ca' faltar
  selfSigned: true

pullSecret:
  kcs-pullsecret:
    registry: "$REGISTRY_SERVER_CONFIG"
    username: "$REGISTRY_USER_CONFIG"
    password: "$REGISTRY_PASS_CONFIG"
    email: "$REGISTRY_EMAIL_CONFIG"

ingress:
  kcs:
    domain: "$DOMAIN_CONFIGURED"
    ingressClass: "nginx"

persistentVolume:
  postgresql: { size: 20Gi }
  pvc-minio: { size: 5Gi }
  pvc-clickhouse-cold: { size: 40Gi }
  pvc-clickhouse-hot: { size: 20Gi }

# ----------- #
#   Secrets   #
# ----------- #

secret:
  infracreds:
    type: fromEnvs
    envs:
      POSTGRES_USER: "$POSTGRES_USER_CONFIG"
      POSTGRES_PASSWORD: "$POSTGRES_PASS_CONFIG"
      MINIO_ROOT_USER: "$MINIO_USER_CONFIG"
      MINIO_ROOT_PASSWORD: "$MINIO_PASS_CONFIG"
      CLICKHOUSE_ADMIN_PASSWORD: "$CH_ADMIN_PASS_CONFIG"
      CLICKHOUSE_WRITE_PASSWORD: "$CH_WRITE_PASS_CONFIG"
      CLICKHOUSE_READ_PASSWORD: "$CH_READ_PASS_CONFIG"
      MCHD_USER: "$MCHD_USER_CONFIG"
      MCHD_PASS: "$MCHD_PASS_CONFIG"
      APP_SECRET: "$APP_SECRET_CONFIG"