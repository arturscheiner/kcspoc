################################################################################
# KCS EDUCATIONAL TEMPLATE - Version 2.3.0
# ------------------------------------------------------------------------------
# üéØ TARGET AUDIENCE: Pre-Sales Engineers & Architects
# ‚ö†Ô∏è ENVIRONMENT: POC / LAB ONLY (Optimized for performance/stability)
#
# üìù WHAT'S NEW IN v2.3.0?
# 1. Secret Management Evolution: Introduction of 'VAULT_PATH' for infraconfig.
# 2. Performance Baseline: Clickhouse and Postgres now require more RAM 
#    to handle advanced v2.3 telemetry and scanning features.
# 3. Enhanced Ingress: Larger buffer sizes for multi-gigabyte image scans.
#
# üõ†Ô∏è TROUBLESHOOTING:
# If you see "Forbidden: updates to statefulset spec", it's because K8s forbids 
# changing immutable fields (like selectors) in an existing StatefulSet.
# FIX: Run 'kubectl delete sts kcs-s3 kcs-postgres kcs-clickhouse -n kcs --cascade=orphan'
# Then, re-run 'kcspoc deploy --core'. This replaces the controller but keeps data.
################################################################################

# --- [TEACHING POINT: METADATA & STATE] ---
# We use 'kcspoc.io' labels to track the 'execution-id' (like your 2M32LB).
# This allows the tool to cross-reference logs with the cluster state.
commonLabels:
  kcspoc.io/managed-by: "kcspoc"
  kcspoc.io/config-hash: "$PROVISION_HASH_CONFIG"
  kcspoc.io/tool-version: "$PROVISION_VERSION_CONFIG"
  kcspoc.io/kcs-version: "2.3.0"

default:
  platform: "$PLATFORM_CONFIGURED"
  domain: "$DOMAIN_CONFIGURED"
  
  # --- [TEACHING POINT: IDENTITY BOOTSTRAP] ---
  certSource: "helm"
  internalTLS:
    enabled: true
    certSource: "helm"
  certManager: true

  # --- [TEACHING POINT: SCANNER UPDATES] ---
  # Essential for syncing the Vulnerability and Malware databases.
  updates:
    enabled: true

  # Lab Optimization: We keep 1 replica of IH to save resources.
  kcs-ih:
    replicaCount: 1

  # --- [TEACHING POINT: NETWORK POLICIES v2.3.x] ---
  # v2.3.x remains strict: you MUST define the Ingress namespaces.
  networkPolicies:
    create: true
    ingressControllerNamespaces:
      - ingress-nginx

  # --- [TEACHING POINT: v2.3 RESOURCE DEMAND] ---
  # Version 2.3 is more demanding. We increased PostgreSQL to 1Gi RAM 
  # to prevent OOMKills during the new 'policy migration' tasks of v2.3.
  postgresql:
    resources:
      requests: { cpu: "200m", memory: "1Gi" }
      limits: { cpu: "1", memory: "2Gi" }

nodeAgent:
  enabled: true
  runtimeSocketPath: "$CRI_SOCKET_CONFIG"

admissionController:
  enabled: true
  
configmap:
  infraconfig:
    type: fromEnvs
    envs:
      TLS_INTERNAL: true
      # --- [TEACHING POINT: VAULT INTEGRATION] ---
      # Starting with v2.3, KCS uses a internal Vault-like path logic.
      # 'VAULT_PATH' points to the ConfigMap key containing the environment data.
      VAULT_PATH: "infraconfig"
      KUBE_AGENT_TAG: v2.3.0
      NODE_AGENT_TAG: v2.3.0
      SCANNER_TAG: v2.3.0
      IMAGE_TAG_MIDDLEWARE: v2.3.0

issuer:
  create: true
  name: kcs-issuer
  kind: Issuer
  selfSigned: true

pullSecret:
  kcs-pullsecret:
    registry: "$REGISTRY_SERVER_CONFIG"
    username: "$REGISTRY_USER_CONFIG"
    password: "$REGISTRY_PASS_CONFIG"
    email: "$REGISTRY_EMAIL_CONFIG"

ingress:
  kcs:
    domain: "$DOMAIN_CONFIGURED"
    ingressClass: "nginx"
    annotations:
      # --- [TEACHING POINT: LARGE IMAGE HANDLING] ---
      # In v2.3, scan payloads can be larger. We increase proxy-body-size to 2GB.
      nginx.ingress.kubernetes.io/proxy-body-size: "2048m"

persistentVolume:
  postgresql: { size: 20Gi }
  pvc-minio: { size: 10Gi }
  pvc-clickhouse-cold: { size: 40Gi }
  pvc-clickhouse-hot: { size: 20Gi }

# --- [TEACHING POINT: CLICKHOUSE STABILITY] ---
# Clickhouse is the event/alert storage engine. 
# v2.3.0 requires 2Gi RAM to initialize the new analytical schemas.
component:
  kcs-clickhouse:
    resources:
      requests: { cpu: "500m", memory: "2Gi" }
      limits: { cpu: "2", memory: "4Gi" }

secret:
  infracreds:
    type: fromEnvs
    envs:
      POSTGRES_USER: "$POSTGRES_USER_CONFIG"
      POSTGRES_PASSWORD: "$POSTGRES_PASS_CONFIG"
      MINIO_ROOT_USER: "$MINIO_USER_CONFIG"
      MINIO_ROOT_PASSWORD: "$MINIO_PASS_CONFIG"
      CLICKHOUSE_ADMIN_PASSWORD: "$CH_ADMIN_PASS_CONFIG"
      CLICKHOUSE_WRITE_PASSWORD: "$CH_WRITE_PASS_CONFIG"
      CLICKHOUSE_READ_PASSWORD: "$CH_READ_PASS_CONFIG"
      MCHD_USER: "$MCHD_USER_CONFIG"
      MCHD_PASS: "$MCHD_PASS_CONFIG"
      # --- [TEACHING POINT: THE MASTER KEY] ---
      # APP_SECRET is the encryption key. 
      # DO NOT CHANGE it if you are preserving data volumes (PVCs).
      APP_SECRET: "$APP_SECRET_CONFIG"